#!/bin/bash
SESSION_NAME="dream_mobile_base"
# heredoc: a way to define a multiline string. Treated as if a separate file
# Python also has this multiline docstring

usage(){
    cat << EOF
This is the main script that builds the workspacem and launches all necessary nodes on Rpi. 
    - b: build catkin workspace. If it fails, then the script will exit
    - l : launch all nodes
EOF
}

DO_CATKIN_BUILD=false
LAUNCH_ALL=false

# :l means no input value. have to store option there.
# \? is to escape ?. ? is a special getopts character
# getopts does not shift options for you. So you might want to shift by yourself
# variable name OPTION should match with the getopts arg
while getopts ":l:b" OPTION; do
    case "${OPTION}" in
        b)
            DO_CATKIN_BUILD=true
            echo "Doing catkin build"
            ;;
        l)
            LAUNCH_ALL=true
            echo "LAUNCHING ALL NODES"
            ;;
        \?)
            echo "Invalid Option: -${OPTION}"
            usage
            exit 1
            ;;
    esac
done 

# do catkin build
if [[ $DO_CATKIN_BUILD == true ]]; then
    # WORKDIRECTORY is defined in the dockerfile
    cd ${WORKDIRECTORY} && catkin build && source ${WORKDIRECTORY}/devel/setup.bash
    if [[ $? -ne 0 ]]; then
        echo "catkin build failed"
        exit 1
    fi
fi


# Ternary in bash could be tricky. I'm not using that.
if [[ $LAUNCH_ALL == true ]]; then 
    SEND_KEY="C-m"
else
    SEND_KEY=""
fi

byobu new-session -d -s $SESSION_NAME
byobu send-keys -t $SESSION_NAME "roslaunch dream_mobile_platform low_level_drivers.launch" ${SEND_KEY}
# Rename the window to "drivers".
byobu rename-window -t $SESSION_NAME "low_level_drivers"
# Attach to the session.
byobu attach -t $SESSION_NAME