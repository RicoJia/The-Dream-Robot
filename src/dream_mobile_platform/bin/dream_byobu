#!/bin/bash
SESSION_NAME="dream_mobile_base"
# heredoc: a way to define a multiline string. Treated as if a separate file
# Python also has this multiline docstring

usage(){
    cat << EOF
This is the main script that builds the workspacem and launches all necessary nodes on Rpi. 
    - b: build catkin workspace. If it fails, then the script will exit
    - l : launch all nodes
EOF
}

DO_CATKIN_BUILD=false
LAUNCH_ALL=false

# l means no input value. have to store option there. otherwise, do l: and provide an input value
# \? is to escape ?. ? is a special getopts character
# getopts does not shift options for you. So you might want to shift by yourself
# variable name OPTION should match with the getopts arg
while getopts "lb" OPTION; do
    case "${OPTION}" in
        b)
            DO_CATKIN_BUILD=true
            echo "Doing catkin build"
            ;;
        l)
            LAUNCH_ALL=true
            echo "LAUNCHING ALL NODES"
            ;;
        \?)
            echo "Invalid Option: -${OPTION}"
            usage
            exit 1
            ;;
    esac
done 

# do catkin build
if [[ $DO_CATKIN_BUILD == true ]]; then
    # WORKDIRECTORY is defined in the dockerfile
    cd ${WORKDIRECTORY} && catkin build
    if [[ $? -ne 0 ]]; then
        echo "catkin build failed"
        exit 1
    fi

    git config --global --add safe.directory ${WORKDIRECTORY}
    git config --global --add safe.directory ${WORKDIRECTORY}/src/SimpleRoboticsPythonUtils
    cd ${WORKDIRECTORY}/src && git submodule update --init --recursive
    cd ${WORKDIRECTORY}/src/SimpleRoboticsPythonUtils && pip3 install -e .
fi



# Ternary in bash could be tricky. I'm not using that.
if [[ $LAUNCH_ALL == true ]]; then 
    SEND_KEY="C-m"
else
    SEND_KEY=""
fi

byobu new-session -d -s $SESSION_NAME
# Byobu window processes are children of the tmux server process.


byobu send-keys -t $SESSION_NAME "sudo pigpiod && roslaunch dream_mobile_platform low_level_drivers.launch" ${SEND_KEY}
# Rename the window to "drivers".
byobu rename-window -t $SESSION_NAME "low_level_drivers"
byobu new-window -t $SESSION_NAME -n "camera_service" 
byobu send-keys -t $SESSION_NAME:"camera_service" "rosrun dream_mobile_platform camera_service.bash" ${SEND_KEY}

# Attach to the session.
byobu attach -t $SESSION_NAME
